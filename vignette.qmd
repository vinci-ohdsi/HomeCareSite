---
title: "HomeStation Vignette"
author: "Bill O'Brien"
format: 
  html:
    toc: true
    embed-resources: true
editor: source
---

## Introduction

The goal of HomeStation is to associate entries of a cohort table with a Veterans Affairs home station.

## Example use

```{r output=FALSE}

library(HomeStation)
library(ggplot2) 
library(dplyr)
library(forcats)

Sys.setenv(DATABASECONNECTOR_JAR_FOLDER = "O:/VINCI_OHDSI/JDBC/sqljdbc_6.0/enu/jre8")

connectionDetails <- DatabaseConnector::createConnectionDetails(
  dbms = "sql server",
  server = "vhacdwdwhdbs102")

con <- DatabaseConnector::connect(connectionDetails)

```

Instantiate an R6 object with parameters for the database connection, CDM schema, and cohort table.

The `getHomeStation` method writes a dataframe within the object consisting of the cohort table plus a column for derived home station.

```{r output=FALSE}

x <- HomeStation$new(con, 
                     "cdw_omop.omopv5", 
                     "ORD_OHDSI.wjo.dalbavancin")

x$getHomeStation() 

```

```{r}

x$homeStation |>
  count(station) |>
  filter(n >= 25) |> 
  ggplot(aes(x = n, 
             y = fct_reorder(station, n),
             fill = station)) +
  theme(legend.position = 'none') +
  geom_col() +
  labs(x = 'Number of cohort entries',
       y = 'VA station code',
       title = 'Home station of members of dalbavancin cohort',
       subtitle = 'Excludes stations with n < 25')

```
